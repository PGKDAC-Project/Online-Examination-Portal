version: '3.8'

services:
  # MySQL Database for Spring Boot Service
  mysql_spring:
    image: mysql:8.0
    container_name: oep_mysql_spring
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: student_instructor_service_db
      MYSQL_USER: kd2-harsh-92448
      MYSQL_PASSWORD: manager
    ports:
      - "3306:3306"
    volumes:
      - mysql_spring_data:/var/lib/mysql
    networks:
      - oep_network

  # MySQL Database for Admin Service
  mysql_admin:
    image: mysql:8.0
    container_name: oep_mysql_admin
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: admin_service_db
      MYSQL_USER: kd2-harsh-92448
      MYSQL_PASSWORD: manager
    ports:
      - "3307:3306"
    volumes:
      - mysql_admin_data:/var/lib/mysql
    networks:
      - oep_network

  # Spring Boot Backend
  spring_backend:
    build:
      context: ./oep_spring_backend
      dockerfile: Dockerfile
    container_name: oep_spring_backend
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql_spring:3306/student_instructor_service_db?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: kd2-harsh-92448
      SPRING_DATASOURCE_PASSWORD: manager
      JWT_SECRET: 617b7c292a0698a897e6ff73324285be2ca049857c8802e26a4cce2214d899c4
    ports:
      - "8080:8080"
    depends_on:
      - mysql_spring
    networks:
      - oep_network

  # .NET Admin Service
  admin_service:
    build:
      context: ./AdminServiceDotNET
      dockerfile: Dockerfile
    container_name: oep_admin_service
    environment:
      ConnectionStrings__AdminDb: "server=mysql_admin;database=admin_service_db;user=kd2-harsh-92448;password=manager"
      Jwt__Secret: "617b7c292a0698a897e6ff73324285be2ca049857c8802e26a4cce2214d899c4"
      SpringBackendUrl: "http://spring_backend:8080/oep"
      FrontendUrl: "http://localhost:5173" # Nginx serves on this port
    ports:
      - "7097:7097"
    depends_on:
      - mysql_admin
      - spring_backend
    networks:
      - oep_network

  # React Frontend
  frontend:
    build:
      context: ./frontend-Application
      dockerfile: Dockerfile
    container_name: oep_frontend
    environment:
      VITE_API_BASE_URL: http://localhost:8080/oep
      VITE_ADMIN_API_BASE_URL: http://localhost:7097
    ports:
      - "5173:5173"
    depends_on:
      - spring_backend
      - admin_service
    networks:
      - oep_network

volumes:
  mysql_spring_data:
  mysql_admin_data:

networks:
  oep_network:
    driver: bridge